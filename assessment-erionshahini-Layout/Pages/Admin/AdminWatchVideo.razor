@page "/admin/watch/{Id:guid}"
@attribute [Authorize(Roles = "Admin")]
@using assessment_erionshahini_Layout.Data
@using assessment_erionshahini_Layout.Service
@using System.Linq
@using Microsoft.Extensions.Caching.Memory
@using Microsoft.JSInterop
@implements IAsyncDisposable

<PageTitle>@(video?.Title ?? "Video") - Admin - Video Lab</PageTitle>

<div class="vl-page vl-watch-page">
    <div class="vl-admin-toolbar">
        <a href="/admin" class="vl-admin-back-link">‚Üê Back to videos</a>
        @if (video != null)
        {
            <button type="button" class="vl-btn vl-btn-danger vl-admin-delete-btn" disabled="@_deleting" @onclick="ConfirmAndDeleteVideoAsync" title="Delete this video permanently">
                @(_deleting ? "Deleting‚Ä¶" : "Delete video")
            </button>
        }
    </div>
    @if (error != null)
    {
        <div class="vl-alert vl-alert-error">@error</div>
    }
    else if (video == null && !loading)
    {
        <p>Video not found.</p>
    }
    else if (video != null)
    {
        @if (!string.IsNullOrEmpty(streamUrl))
        {
            <div class="vl-watch-shell">
                <div class="vl-video-wrap vl-video-wrap-plyr" id="vl-watch-player-wrap" @key="streamUrl">
                    <video id="vl-watch-video" @ref="_videoRef" preload="auto" class="vl-video-player" src="@streamUrl">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>
            <p class="vl-watch-fallback">
                <a href="@streamUrl" target="_blank" rel="noopener">Open video in new tab</a> if it does not play above.
                @if (_pipSupported == true)
                {
                    <span class="vl-watch-fallback-sep">‚Ä¢</span>
                    <button type="button" class="vl-pip-btn" @onclick="TogglePiPAsync">@(_isInPiP ? "Close PiP" : "Open in PiP")</button>
                }
                else if (_pipSupported == false)
                {
                    <span class="vl-watch-fallback-sep">‚Ä¢</span>
                    <span class="vl-pip-unsupported">PiP is not supported by this browser.</span>
                }
            </p>

            <div class="vl-notes-layout">
                <div class="vl-watch-notes-intro">
                    <p class="vl-watch-notes-intro-text">View only (admin). Click a timestamp (min:sec) to jump to that point in the video.</p>
                    @if (annotations.Count > 0 || bookmarks.Count > 0)
                    {
                        <div class="vl-watch-notes-preview">
                            @if (annotations.Count > 0)
                            {
                                <div class="vl-preview-group">
                                    <p class="vl-preview-group-title">Annotations</p>
                                    <ul class="vl-preview-list">
                                        @foreach (var a in annotations.Take(4))
                                        {
                                            <li class="vl-preview-item">
                                                <button type="button" class="vl-preview-time vl-seek-btn" data-seek="@a.TimestampSeconds.ToString(System.Globalization.CultureInfo.InvariantCulture)" title="Jump to this moment">@FormatTime(a.TimestampSeconds)</button>
                                                <span class="vl-preview-text">@a.Description</span>
                                            </li>
                                        }
                                    </ul>
                                </div>
                            }
                            @if (bookmarks.Count > 0)
                            {
                                <div class="vl-preview-group">
                                    <p class="vl-preview-group-title">Bookmarks</p>
                                    <ul class="vl-preview-list">
                                        @foreach (var b in bookmarks.Take(4))
                                        {
                                            <li class="vl-preview-item">
                                                <button type="button" class="vl-preview-time vl-seek-btn" data-seek="@b.TimestampSeconds.ToString(System.Globalization.CultureInfo.InvariantCulture)" title="Jump to this moment">@FormatTime(b.TimestampSeconds)</button>
                                                <span class="vl-preview-text">@b.Title</span>
                                            </li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    }
                </div>

                <div class="vl-watch-notes">
                    <section class="vl-notes-section">
                        <div class="vl-section-heading">
                            <h2 class="vl-notes-section-title">üìù Annotations</h2>
                            @if (annotations.Count > 0)
                            {
                                <span class="vl-count-badge">@annotations.Count</span>
                            }
                        </div>
                        <p class="vl-notes-section-desc">Notes at a specific video moment. Click a timestamp to jump there. (View only.)</p>
                        @if (annotations.Count == 0)
                        {
                            <p class="vl-empty-notes">No annotations.</p>
                        }
                        else
                        {
                            <ul class="vl-notes-list">
                                @foreach (var a in annotations)
                                {
                                    var annTime = a.TimestampSeconds;
                                    var annId = a.Id;
                                    <li class="vl-note-item @(annId == _activeAnnotationId ? "is-active" : "")">
                                        <button type="button" class="vl-note-time vl-seek-btn" data-seek="@annTime.ToString(System.Globalization.CultureInfo.InvariantCulture)" title="Jump to this moment in the video">@FormatTime(annTime)</button>
                                        <span class="vl-note-text">@a.Description</span>
                                    </li>
                                }
                            </ul>
                        }
                    </section>

                    <section class="vl-notes-section">
                        <div class="vl-section-heading">
                            <h2 class="vl-notes-section-title">üîñ Bookmarks</h2>
                            @if (bookmarks.Count > 0)
                            {
                                <span class="vl-count-badge">@bookmarks.Count</span>
                            }
                        </div>
                        <p class="vl-notes-section-desc">Saved points to return to a part of the video. Click a timestamp to jump there. (View only.)</p>
                        @if (bookmarks.Count == 0)
                        {
                            <p class="vl-empty-notes">No bookmarks.</p>
                        }
                        else
                        {
                            <ul class="vl-notes-list">
                                @foreach (var b in bookmarks)
                                {
                                    var bookTime = b.TimestampSeconds;
                                    <li class="vl-note-item">
                                        <button type="button" class="vl-note-time vl-seek-btn" data-seek="@bookTime.ToString(System.Globalization.CultureInfo.InvariantCulture)" title="Jump to this moment in the video">@FormatTime(bookTime)</button>
                                        <span class="vl-note-text">@b.Title</span>
                                    </li>
                                }
                            </ul>
                        }
                    </section>
                </div>
            </div>
        }
    }
    else
    {
        <p class="vl-text-muted">Loading‚Ä¶</p>
    }
</div>

@code {
    [Parameter] public Guid Id { get; set; }
    [Inject] private AuthenticatedApiClient Api { get; set; } = null!;
    [Inject] private IMemoryCache Cache { get; set; } = null!;
    [Inject] private NavigationManager Navigation { get; set; } = null!;
    [Inject] private IJSRuntime JS { get; set; } = null!;
    [Inject] private IStreamTokenService StreamToken { get; set; } = null!;

    private ElementReference _videoRef;
    private VideoItem? video;
    private string? streamUrl;
    private bool loading = true;
    private string? error;

    private List<AnnotationItem> annotations = new();
    private List<BookmarkItem> bookmarks = new();
    private bool? _pipSupported;
    private bool _isInPiP;
    private DotNetObjectReference<AdminWatchVideo>? _selfRef;
    private Guid? _activeAnnotationId;
    private string? _activeAnnotationText;
    private double _activeAnnotationTime;
    private bool _deleting;
    private bool _plyrInited;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            video = await Api.GetVideoByIdAsync(Id);
            if (video != null)
            {
                var token = Guid.NewGuid().ToString("N");
                Cache.Set($"stream:{Id}:{token}", true, TimeSpan.FromMinutes(2));
                var streamJwt = StreamToken.CreateStreamToken(Id);
                var baseUrl = Navigation.BaseUri.TrimEnd('/');
                streamUrl = $"{baseUrl}/stream/{Id}?t={token}&st={Uri.EscapeDataString(streamJwt)}";
                await LoadNotesAsync();
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (string.IsNullOrEmpty(streamUrl))
            return;

        if (!_plyrInited)
        {
            try
            {
                _selfRef = DotNetObjectReference.Create(this);
                var bookmarksSeconds = bookmarks.Select(b => b.TimestampSeconds).ToArray();
                var annotationsData = annotations
                    .Select(a => new { time = a.TimestampSeconds, text = a.Description ?? "" })
                    .ToArray();

                await JS.InvokeVoidAsync("videoPlayerInit", new
                {
                    containerId = "vl-watch-player-wrap",
                    videoId = "vl-watch-video",
                    src = streamUrl,
                    bookmarks = bookmarksSeconds,
                    annotations = annotationsData,
                    dotNetRef = _selfRef,
                    timeUpdateCallback = nameof(OnVideoTimeUpdate)
                });
                _plyrInited = true;

                _pipSupported = await JS.InvokeAsync<bool>("videoLabCanPiP", "vl-watch-video");
                _isInPiP = false;
                StateHasChanged();
            }
            catch
            {
                _pipSupported = false;
            }
        }
        else
        {
            try
            {
                var bookmarksSeconds = bookmarks.Select(b => b.TimestampSeconds).ToArray();
                var annotationsData = annotations
                    .Select(a => new { time = a.TimestampSeconds, text = a.Description ?? "" })
                    .ToArray();
                await JS.InvokeVoidAsync("videoPlayerUpdateMarkers", "vl-watch-video", bookmarksSeconds);
                await JS.InvokeVoidAsync("videoPlayerUpdateAnnotations", "vl-watch-video", annotationsData);
            }
            catch { /* ignore */ }
        }
    }

    [JSInvokable]
    public Task OnVideoTimeUpdate(double currentTime)
    {
        var match = annotations
            .Where(a => Math.Abs(a.TimestampSeconds - currentTime) <= 0.6d)
            .OrderBy(a => Math.Abs(a.TimestampSeconds - currentTime))
            .FirstOrDefault();

        if (match != null)
        {
            if (_activeAnnotationId != match.Id)
            {
                _activeAnnotationId = match.Id;
                _activeAnnotationText = match.Description;
                _activeAnnotationTime = match.TimestampSeconds;
                _ = InvokeAsync(StateHasChanged);
            }
        }
        else if (_activeAnnotationId.HasValue)
        {
            _activeAnnotationId = null;
            _activeAnnotationText = null;
            _activeAnnotationTime = 0;
            _ = InvokeAsync(StateHasChanged);
        }

        return Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("videoPlayerDestroy", "vl-watch-video");
        }
        catch
        {
            // Ignore cleanup failures on disposal.
        }
        _selfRef?.Dispose();
    }

    private async Task LoadNotesAsync()
    {
        try
        {
            var ann = await Api.GetAnnotationsByVideoAsync(Id);
            var book = await Api.GetBookmarksByVideoAsync(Id);
            annotations = ann ?? new List<AnnotationItem>();
            bookmarks = book ?? new List<BookmarkItem>();
            StateHasChanged();
        }
        catch
        {
            annotations = new List<AnnotationItem>();
            bookmarks = new List<BookmarkItem>();
        }
    }

    private async Task TogglePiPAsync()
    {
        if (_pipSupported != true)
            return;

        try
        {
            if (_isInPiP)
                await JS.InvokeVoidAsync("videoLabExitPiP");
            else
                await JS.InvokeVoidAsync("videoLabEnterPiP", "vl-watch-video");

            _isInPiP = await JS.InvokeAsync<bool>("videoLabIsPiP", "vl-watch-video");
        }
        catch
        {
            _isInPiP = false;
        }
    }

    private static string FormatTime(double seconds)
    {
        var t = TimeSpan.FromSeconds(seconds);
        return $"{(int)t.TotalMinutes}:{t.Seconds:D2}";
    }

    private async Task ConfirmAndDeleteVideoAsync()
    {
        var msg = "Are you sure you want to delete this video? This action cannot be undone.";
        var confirmed = await JS.InvokeAsync<bool>("confirm", msg);
        if (!confirmed) return;

        _deleting = true;
        error = null;
        try
        {
            await Api.DeleteVideoAsync(Id);
            Navigation.NavigateTo("/admin", forceLoad: false);
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            _deleting = false;
        }
    }
}

<style>
    .vl-admin-toolbar {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin: 0 0 1rem 0;
        flex-wrap: wrap;
    }
    .vl-admin-back-link {
        font-size: 0.9rem;
        color: var(--vl-accent);
        text-decoration: none;
    }
    .vl-admin-back-link:hover {
        text-decoration: underline;
    }
    .vl-admin-delete-btn {
        margin-left: auto;
    }
    .vl-btn-danger {
        background: var(--vl-danger, #dc2626);
        color: #fff;
        border: none;
        padding: 0.4rem 0.85rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
    }
    .vl-btn-danger:hover:not(:disabled) {
        background: #b91c1c;
    }
    .vl-btn-danger:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
    .vl-watch-page {
        max-width: none;
        width: 100%;
        margin-top: calc(30px - 1.5rem);
        padding-top: 0;
    }
    .vl-watch-shell {
        margin-top: 0;
        margin-bottom: 0.75rem;
    }
    .vl-video-wrap {
        margin-left: 100px;
        width: 900px;
        height: 500px;
        max-width: calc(100% - 100px);
        background: #000;
        border-radius: var(--vl-radius);
        box-shadow: var(--vl-shadow-lg);
        position: relative;
        overflow: visible;
        z-index: 1;
        isolation: isolate;
    }
    .vl-video-player {
        width: 100%;
        height: 100%;
        display: block;
        object-fit: contain;
        background: #000;
    }
    .vl-video-wrap-plyr .plyr {
        position: relative;
        width: 100%;
        height: 100%;
        min-height: 0;
        border-radius: var(--vl-radius);
        overflow: hidden;
        z-index: 0;
    }
    .vl-video-wrap-plyr .plyr__video-wrapper {
        flex: 1 1 auto;
        min-height: 0;
    }
    .vl-plyr-annotation-overlay {
        position: absolute;
        left: 50%;
        top: 0.75rem;
        transform: translateX(-50%);
        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid rgba(34, 211, 238, 0.7);
        color: #f8fafc;
        border-radius: 12px;
        padding: 0.52rem 0.82rem;
        max-width: calc(100% - 2rem);
        z-index: 2;
        pointer-events: none;
        backdrop-filter: blur(6px);
        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.35);
    }
    .vl-video-wrap-plyr .plyr--fullscreen .vl-plyr-annotation-overlay {
        top: 1rem;
        z-index: 2;
    }
    .vl-plyr-annotation-time {
        background: rgba(6, 182, 212, 0.25);
        color: #a5f3fc;
        border-radius: 999px;
        padding: 0.14rem 0.5rem;
        font-size: 0.78rem;
        font-weight: 800;
        white-space: nowrap;
    }
    .vl-plyr-annotation-text {
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: min(560px, calc(100vw - 4rem));
    }
    .vl-plyr-markers {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 2;
    }
    .vl-plyr-marker {
        pointer-events: auto;
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 10px;
        height: 10px;
        margin-left: 0;
        padding: 0;
        border: none;
        border-radius: 50%;
        background: #06b6d4;
        cursor: pointer;
        z-index: 3;
        box-shadow: 0 0 0 2px rgba(255,255,255,0.8);
    }
    .vl-plyr-marker:hover {
        background: #22d3ee;
        transform: translate(-50%, -50%) scale(1.2);
    }
    .vl-video-wrap-plyr .plyr__progress {
        position: relative;
        overflow: visible;
    }
    .vl-video-wrap-plyr .plyr__controls {
        z-index: 3;
    }
    .vl-watch-fallback {
        margin: 0 0 1rem 0;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.45rem;
    }
    .vl-watch-fallback a { color: var(--vl-accent); }
    .vl-active-annotation {
        margin: 0 0 1rem 0;
        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
        background: #ecfeff;
        border: 1px solid #99f6e4;
        color: #0f172a;
        border-radius: 12px;
        padding: 0.45rem 0.7rem;
        max-width: min(900px, calc(100% - 100px));
    }
    .vl-active-annotation-time {
        background: #cffafe;
        color: #155e75;
        border-radius: 999px;
        padding: 0.14rem 0.5rem;
        font-size: 0.78rem;
        font-weight: 800;
        white-space: nowrap;
    }
    .vl-active-annotation-text {
        font-size: 0.85rem;
        font-weight: 600;
    }
    .vl-watch-fallback-sep { color: var(--vl-text-muted); line-height: 1; }
    .vl-pip-btn {
        border: 1px solid var(--vl-border);
        background: #fff;
        color: var(--vl-text);
        border-radius: 999px;
        padding: 0.2rem 0.65rem;
        font-size: 0.75rem;
        font-weight: 700;
        cursor: pointer;
    }
    .vl-pip-btn:hover { background: #f8fafc; }
    .vl-pip-unsupported { color: var(--vl-text-muted); font-size: 0.78rem; }
    .vl-watch-notes-intro {
        max-width: 360px;
        padding: 0.9rem 1.1rem;
        background: #fff;
        border: 1px solid var(--vl-border);
        border-radius: 14px;
        font-size: 0.9375rem;
        color: var(--vl-text);
        box-shadow: var(--vl-shadow);
        align-self: start;
        position: sticky;
        top: 1rem;
    }
    .vl-watch-notes-intro-text { margin: 0 0 0.5rem 0; }
    .vl-watch-notes-preview {
        display: grid;
        gap: 0.75rem;
        margin-top: 0.5rem;
    }
    .vl-preview-group {
        border: 1px solid var(--vl-border);
        border-radius: 12px;
        background: #f8fafc;
        padding: 0.6rem;
    }
    .vl-preview-group-title {
        margin: 0 0 0.45rem 0;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        font-weight: 800;
        color: var(--vl-text-muted);
    }
    .vl-preview-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 0.4rem;
    }
    .vl-preview-item {
        display: grid;
        grid-template-columns: auto 1fr;
        align-items: center;
        gap: 0.45rem;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.32rem 0.45rem;
    }
    .vl-preview-time,
    .vl-note-time {
        border: none;
        background: var(--vl-accent-muted);
        color: #0e7490;
        font-weight: 700;
        cursor: pointer;
        padding: 0.22rem 0.55rem;
        border-radius: 999px;
        font-size: 0.8125rem;
        transition: background 0.2s ease, transform 0.2s ease;
    }
    .vl-preview-time:hover,
    .vl-note-time:hover {
        background: rgba(6, 182, 212, 0.2);
        transform: translateY(-1px);
    }
    .vl-preview-text {
        min-width: 0;
        font-size: 0.84rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .vl-watch-notes {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.9rem;
        min-width: 0;
    }
    .vl-notes-layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(280px, 360px);
        gap: 1rem;
        max-width: 1200px;
        align-items: start;
    }
    .vl-notes-section {
        background: #fff;
        border-radius: 14px;
        padding: 0.9rem;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
    }
    .vl-section-heading {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.35rem;
    }
    .vl-notes-section-title {
        font-size: 1rem;
        margin: 0;
        color: var(--vl-text);
    }
    .vl-count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 1.6rem;
        height: 1.35rem;
        padding: 0 0.45rem;
        border-radius: 999px;
        background: #eef2ff;
        color: #1e40af;
        font-size: 0.75rem;
        font-weight: 800;
    }
    .vl-notes-section-desc {
        font-size: 0.78rem;
        color: var(--vl-text-muted);
        margin: 0 0 0.7rem 0;
    }
    .vl-empty-notes {
        font-size: 0.84rem;
        color: var(--vl-text-muted);
        margin: 0;
    }
    .vl-notes-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 0.45rem;
    }
    .vl-note-item {
        display: grid;
        grid-template-columns: auto 1fr;
        align-items: center;
        gap: 0.6rem;
        padding: 0.55rem 0.55rem;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #fff;
        transition: border-color 0.2s ease, background 0.2s ease, transform 0.2s ease;
    }
    .vl-note-item:hover {
        border-color: #c7d2fe;
        background: #f8fafc;
        transform: translateY(-1px);
    }
    .vl-note-item.is-active {
        border-color: #06b6d4;
        background: #ecfeff;
    }
    .vl-note-text {
        min-width: 0;
        font-size: 0.875rem;
    }
    .vl-note-time {
        background: #e0f2fe;
        color: #075985;
        font-size: 0.78rem;
        padding: 0.24rem 0.58rem;
    }
    @@media (max-width: 1200px) {
        .vl-video-wrap {
            margin-left: 0;
            width: 700px;
            max-width: 100%;
        }
        .vl-active-annotation { max-width: 700px; }
    }
    @@media (max-width: 860px) {
        .vl-notes-layout { grid-template-columns: 1fr; }
        .vl-watch-notes-intro {
            max-width: 100%;
            position: static;
        }
    }
    @@media (max-width: 760px) {
        .vl-video-wrap {
            width: 100%;
            max-width: 100%;
            margin-left: 0;
            height: 320px;
        }
        .vl-active-annotation { max-width: 100%; }
    }
</style>
