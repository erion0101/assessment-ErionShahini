@page "/user/watch/{Id:guid}"
@attribute [Authorize]
@using assessment_erionshahini_Layout.Data
@using assessment_erionshahini_Layout.Service
@using System.Linq
@using Microsoft.Extensions.Caching.Memory
@using Microsoft.JSInterop
@implements IAsyncDisposable

<PageTitle>@(video?.Title ?? "Video") - Video Lab</PageTitle>

<div class="vl-page vl-watch-page">
    @if (error != null)
    {
        <div class="vl-alert vl-alert-error">@error</div>
    }
    else if (video == null && !loading)
    {
        <p>Video not found.</p>
    }
    else if (video != null)
    {
        @if (!string.IsNullOrEmpty(streamUrl))
        {
            <div class="vl-watch-actions">
                <a href="/user/index" class="vl-watch-back-link">‚Üê My Videos</a>
                <button type="button" class="vl-btn vl-btn-danger vl-watch-delete-btn" disabled="@_deleting" @onclick="ConfirmAndDeleteVideoAsync" title="Delete this video permanently">
                    @(_deleting ? "Deleting‚Ä¶" : "Delete video")
                </button>
            </div>
            <div class="vl-watch-shell">
                <div class="vl-video-wrap vl-video-wrap-plyr" id="vl-watch-player-wrap" @key="streamUrl">
                    <video id="vl-watch-video" @ref="_videoRef" preload="auto" class="vl-video-player" src="@streamUrl">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>
            <p class="vl-watch-fallback">
                <a href="@streamUrl" target="_blank" rel="noopener">Open video in new tab</a> if it does not play above.
                @if (_pipSupported == true)
                {
                    <span class="vl-watch-fallback-sep">‚Ä¢</span>
                    <button type="button" class="vl-pip-btn" @onclick="TogglePiPAsync">@(_isInPiP ? "Close PiP" : "Open in PiP")</button>
                }
                else if (_pipSupported == false)
                {
                    <span class="vl-watch-fallback-sep">‚Ä¢</span>
                    <span class="vl-pip-unsupported">PiP is not supported by this browser.</span>
                }
            </p>
            @if (_taniMessage != null)
            {
                <p class="vl-tani-message" role="alert">@_taniMessage</p>
            }
            <div class="vl-notes-layout">
                <div class="vl-watch-notes">
                <section class="vl-notes-section vl-notes-section-bookmarks">
                    <div class="vl-section-heading">
                        <h2 class="vl-notes-section-title">üîñ Bookmarks</h2>
                        @if (bookmarks.Count > 0)
                        {
                            <span class="vl-count-badge">@bookmarks.Count</span>
                        }
                    </div>
                    <p class="vl-notes-section-desc">Save points to return to a part of the video. Click a timestamp to jump there.</p>

                    <div class="vl-add-card">
                        <span class="vl-add-card-label">Add bookmark</span>
                        <div class="vl-add-form vl-add-form-stacked">
                            <div class="vl-add-form-row vl-add-form-row-desc">
                                <input @bind="_newBookmarkTitle" placeholder="Title" class="vl-input vl-input-text" aria-label="Bookmark title" />
                            </div>
                            <div class="vl-add-form-row vl-add-form-row-actions">
                                <label class="vl-add-form-time-wrap">
                                    <span class="vl-time-label">Time (sec)</span>
                                    <input type="number" step="0.1" min="0" @bind="_newBookmarkTime" class="vl-input vl-input-num" aria-label="Timestamp in seconds" />
                                </label>
                                <button type="button" class="vl-btn vl-btn-sm vl-btn-secondary vl-btn-now" @onclick="UseCurrentTimeForBookmark">Now</button>
                                <button type="button" class="vl-btn vl-btn-sm vl-btn-primary" disabled="@(string.IsNullOrWhiteSpace(_newBookmarkTitle))" @onclick="AddBookmark">Add</button>
                            </div>
                        </div>
                    </div>

                    @if (bookmarks.Count > 0)
                    {
                        <div class="vl-filter-wrap">
                            <input id="vl-bookmark-search" type="text" @bind="_bookmarkFilter" @bind:event="oninput" placeholder="Search bookmarks‚Ä¶" class="vl-input vl-input-search" aria-label="Filter bookmarks" />
                        </div>
                        <ul class="vl-notes-list">
                            @foreach (var b in FilteredBookmarks)
                            {
                                var bookTime = b.TimestampSeconds;
                                var bookId = b.Id;
                                var isEditing = _editingBookmarkId == bookId;
                                <li class="vl-note-item @(isEditing ? "vl-note-item-editing" : "")">
                                    @if (isEditing)
                                    {
                                        <div class="vl-edit-form">
                                            <input @bind="_editBookmarkTitle" class="vl-input vl-input-text vl-edit-input" placeholder="Title" aria-label="Bookmark title" />
                                            <div class="vl-edit-row">
                                                <label class="vl-add-form-time-wrap">
                                                    <span class="vl-time-label">Time</span>
                                                    <input type="number" step="0.1" min="0" @bind="_editBookmarkTime" class="vl-input vl-input-num" />
                                                </label>
                                                <button type="button" class="vl-btn vl-btn-sm vl-btn-secondary vl-btn-now" @onclick="@(() => UseCurrentTimeForEditBookmark())">Now</button>
                                                <button type="button" class="vl-btn vl-btn-sm vl-btn-primary" disabled="@(string.IsNullOrWhiteSpace(_editBookmarkTitle))" @onclick="@(() => SaveBookmark(bookId))">Save</button>
                                                <button type="button" class="vl-btn vl-btn-sm vl-btn-secondary" @onclick="CancelEditBookmark">Cancel</button>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <button type="button" class="vl-note-time vl-seek-btn" data-kind="bookmark" data-seek="@bookTime.ToString(System.Globalization.CultureInfo.InvariantCulture)" title="Jump to this moment">@FormatTime(bookTime)</button>
                                        <span class="vl-note-text">@b.Title</span>
                                        <div class="vl-note-actions">
                                            <button type="button" class="vl-btn vl-btn-icon vl-btn-edit" aria-label="Edit bookmark" @onclick="@(() => StartEditBookmark(bookId, b))" title="Edit">‚úé</button>
                                            <button type="button" class="vl-btn vl-btn-icon vl-btn-remove" aria-label="Delete bookmark" @onclick="@(() => DeleteBookmark(bookId))" title="Remove">√ó</button>
                                        </div>
                                    }
                                </li>
                            }
                        </ul>
                        @if (FilteredBookmarks.Count == 0 && !string.IsNullOrWhiteSpace(_bookmarkFilter))
                        {
                            <p class="vl-empty-notes vl-empty-filtered">No bookmarks match "<em>@_bookmarkFilter</em>".</p>
                        }
                    }
                    else
                    {
                        <p class="vl-empty-notes">No bookmarks yet. Add one above.</p>
                    }
                </section>

                <section class="vl-notes-section vl-notes-section-annotations">
                    <div class="vl-section-heading">
                        <h2 class="vl-notes-section-title">üìù Annotations</h2>
                        @if (annotations.Count > 0)
                        {
                            <span class="vl-count-badge">@annotations.Count</span>
                        }
                    </div>
                    <p class="vl-notes-section-desc">Notes at a specific moment. Click a timestamp to jump there.</p>

                    <div class="vl-add-card">
                        <span class="vl-add-card-label">Add annotation</span>
                        <div class="vl-add-form vl-add-form-stacked">
                            <div class="vl-add-form-row vl-add-form-row-desc">
                                <input @bind="_newAnnotationDesc" placeholder="Description" class="vl-input vl-input-text" aria-label="Annotation description" />
                            </div>
                            <div class="vl-add-form-row vl-add-form-row-actions">
                                <label class="vl-add-form-time-wrap">
                                    <span class="vl-time-label">Time (sec)</span>
                                    <input type="number" step="0.1" min="0" @bind="_newAnnotationTime" class="vl-input vl-input-num" aria-label="Timestamp in seconds" />
                                </label>
                                <button type="button" class="vl-btn vl-btn-sm vl-btn-secondary vl-btn-now" @onclick="UseCurrentTimeForAnnotation">Now</button>
                                <button type="button" class="vl-btn vl-btn-sm vl-btn-primary" disabled="@(string.IsNullOrWhiteSpace(_newAnnotationDesc))" @onclick="AddAnnotation">Add</button>
                            </div>
                        </div>
                    </div>

                    @if (annotations.Count > 0)
                    {
                        <div class="vl-filter-wrap">
                            <input id="vl-annotation-search" type="text" @bind="_annotationFilter" @bind:event="oninput" placeholder="Search annotations‚Ä¶" class="vl-input vl-input-search" aria-label="Filter annotations" />
                        </div>
                        <ul class="vl-notes-list">
                            @foreach (var a in FilteredAnnotations)
                            {
                                var annTime = a.TimestampSeconds;
                                var annId = a.Id;
                                var isEditing = _editingAnnotationId == annId;
                                <li class="vl-note-item @(annId == _activeAnnotationId && !isEditing ? "is-active" : "") @(isEditing ? "vl-note-item-editing" : "")">
                                    @if (isEditing)
                                    {
                                        <div class="vl-edit-form">
                                            <input @bind="_editAnnotationDesc" class="vl-input vl-input-text vl-edit-input" placeholder="Description" aria-label="Annotation description" />
                                            <div class="vl-edit-row">
                                                <label class="vl-add-form-time-wrap">
                                                    <span class="vl-time-label">Time</span>
                                                    <input type="number" step="0.1" min="0" @bind="_editAnnotationTime" class="vl-input vl-input-num" />
                                                </label>
                                                <button type="button" class="vl-btn vl-btn-sm vl-btn-secondary vl-btn-now" @onclick="@(() => UseCurrentTimeForEditAnnotation())">Now</button>
                                                <button type="button" class="vl-btn vl-btn-sm vl-btn-primary" disabled="@(string.IsNullOrWhiteSpace(_editAnnotationDesc))" @onclick="@(() => SaveAnnotation(annId))">Save</button>
                                                <button type="button" class="vl-btn vl-btn-sm vl-btn-secondary" @onclick="CancelEditAnnotation">Cancel</button>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <button type="button" class="vl-note-time vl-seek-btn" data-kind="annotation" data-seek="@annTime.ToString(System.Globalization.CultureInfo.InvariantCulture)" title="Jump to this moment">@FormatTime(annTime)</button>
                                        <span class="vl-note-text">@a.Description</span>
                                        <div class="vl-note-actions">
                                            <button type="button" class="vl-btn vl-btn-icon vl-btn-edit" aria-label="Edit annotation" @onclick="@(() => StartEditAnnotation(annId, a))" title="Edit">‚úé</button>
                                            <button type="button" class="vl-btn vl-btn-icon vl-btn-remove" aria-label="Delete annotation" @onclick="@(() => DeleteAnnotation(annId))" title="Remove">√ó</button>
                                        </div>
                                    }
                                </li>
                            }
                        </ul>
                        @if (FilteredAnnotations.Count == 0 && !string.IsNullOrWhiteSpace(_annotationFilter))
                        {
                            <p class="vl-empty-notes vl-empty-filtered">No annotations match "<em>@_annotationFilter</em>".</p>
                        }
                    }
                    else
                    {
                        <p class="vl-empty-notes">No annotations yet. Add one above.</p>
                    }
                </section>
            </div>
            </div>
        }
    }
    else
    {
        <p class="vl-text-muted">Loading‚Ä¶</p>
    }
</div>

@code {
    [Parameter] public Guid Id { get; set; }
    [Inject] private AuthenticatedApiClient Api { get; set; } = null!;
    [Inject] private IMemoryCache Cache { get; set; } = null!;
    [Inject] private NavigationManager Navigation { get; set; } = null!;
    [Inject] private IJSRuntime JS { get; set; } = null!;
    [Inject] private IStreamTokenService StreamToken { get; set; } = null!;

    private ElementReference _videoRef;
    private VideoItem? video;
    private string? streamUrl;
    private bool loading = true;
    private string? error;

    private List<AnnotationItem> annotations = new();
    private List<BookmarkItem> bookmarks = new();
    private string _newAnnotationDesc = "";
    private double _newAnnotationTime;
    private string _newBookmarkTitle = "";
    private double _newBookmarkTime;
    private string _annotationFilter = "";
    private string _bookmarkFilter = "";
    private string? _taniMessage;
    private bool? _pipSupported;

    private IReadOnlyList<AnnotationItem> FilteredAnnotations => string.IsNullOrWhiteSpace(_annotationFilter)
        ? annotations
        : annotations.Where(a => (a.Description ?? "").Contains(_annotationFilter, StringComparison.OrdinalIgnoreCase)).ToList();

    private IReadOnlyList<BookmarkItem> FilteredBookmarks => string.IsNullOrWhiteSpace(_bookmarkFilter)
        ? bookmarks
        : bookmarks.Where(b => (b.Title ?? "").Contains(_bookmarkFilter, StringComparison.OrdinalIgnoreCase)).ToList();
    private bool _isInPiP;
    private DotNetObjectReference<Watch>? _selfRef;
    private Guid? _activeAnnotationId;
    private string? _activeAnnotationText;
    private double _activeAnnotationTime;
    private bool _deleting;
    private bool _plyrInited;

    private Guid? _editingAnnotationId;
    private Guid? _editingBookmarkId;
    private string _editAnnotationDesc = "";
    private double _editAnnotationTime;
    private string _editBookmarkTitle = "";
    private double _editBookmarkTime;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            video = await Api.GetVideoByIdAsync(Id);
            if (video != null)
            {
                var token = Guid.NewGuid().ToString("N");
                Cache.Set($"stream:{Id}:{token}", true, TimeSpan.FromMinutes(2));
                var streamJwt = StreamToken.CreateStreamToken(Id);
                var baseUrl = Navigation.BaseUri.TrimEnd('/');
                streamUrl = $"{baseUrl}/stream/{Id}?t={token}&st={Uri.EscapeDataString(streamJwt)}";
                await LoadNotesAsync();
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (string.IsNullOrEmpty(streamUrl))
            return;

        if (!_plyrInited)
        {
            try
            {
                _selfRef = DotNetObjectReference.Create(this);
                var bookmarksSeconds = bookmarks.Select(b => b.TimestampSeconds).ToArray();
                var annotationsData = annotations
                    .Select(a => new { time = a.TimestampSeconds, text = a.Description ?? "" })
                    .ToArray();

                await JS.InvokeVoidAsync("videoPlayerInit", new
                {
                    containerId = "vl-watch-player-wrap",
                    videoId = "vl-watch-video",
                    src = streamUrl,
                    bookmarks = bookmarksSeconds,
                    annotations = annotationsData,
                    dotNetRef = _selfRef,
                    timeUpdateCallback = nameof(OnVideoTimeUpdate)
                });
                _plyrInited = true;

                _pipSupported = await JS.InvokeAsync<bool>("videoLabCanPiP", "vl-watch-video");
                _isInPiP = false;
                StateHasChanged();
            }
            catch
            {
                _pipSupported = false;
            }
        }
        else if (_plyrInited)
        {
            try
            {
                var bookmarksSeconds = bookmarks.Select(b => b.TimestampSeconds).ToArray();
                var annotationsData = annotations
                    .Select(a => new { time = a.TimestampSeconds, text = a.Description ?? "" })
                    .ToArray();
                await JS.InvokeVoidAsync("videoPlayerUpdateMarkers", "vl-watch-video", bookmarksSeconds);
                await JS.InvokeVoidAsync("videoPlayerUpdateAnnotations", "vl-watch-video", annotationsData);
            }
            catch { /* ignore */ }
        }
    }

    [JSInvokable]
    public Task OnVideoTimeUpdate(double currentTime)
    {
        var match = annotations
            .Where(a => Math.Abs(a.TimestampSeconds - currentTime) <= 1.5d)
            .OrderBy(a => Math.Abs(a.TimestampSeconds - currentTime))
            .FirstOrDefault();

        if (match != null)
        {
            if (_activeAnnotationId != match.Id)
            {
                _activeAnnotationId = match.Id;
                _activeAnnotationText = match.Description;
                _activeAnnotationTime = match.TimestampSeconds;
                _ = InvokeAsync(StateHasChanged);
            }
        }
        else if (_activeAnnotationId.HasValue)
        {
            _activeAnnotationId = null;
            _activeAnnotationText = null;
            _activeAnnotationTime = 0;
            _ = InvokeAsync(StateHasChanged);
        }

        return Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("videoPlayerDestroy", "vl-watch-video");
        }
        catch
        {
            // Ignore cleanup failures on disposal.
        }
        _selfRef?.Dispose();
    }

    private async Task LoadNotesAsync()
    {
        try
        {
            var ann = await Api.GetAnnotationsByVideoAsync(Id);
            var book = await Api.GetBookmarksByVideoAsync(Id);
            annotations = ann ?? new List<AnnotationItem>();
            bookmarks = book ?? new List<BookmarkItem>();
            StateHasChanged();
        }
        catch
        {
            annotations = new List<AnnotationItem>();
            bookmarks = new List<BookmarkItem>();
        }
    }

    private async Task UseCurrentTimeForAnnotation()
    {
        _taniMessage = null;
        try
        {
            var s = await JS.InvokeAsync<string>("videoPlayerGetCurrentTime", "vl-watch-video");
            if (!double.TryParse(s, System.Globalization.NumberStyles.Float, System.Globalization.CultureInfo.InvariantCulture, out var t))
                t = 0;
            if (t == 0)
            {
                await Task.Delay(150);
                s = await JS.InvokeAsync<string>("videoPlayerGetCurrentTime", "vl-watch-video");
                double.TryParse(s, System.Globalization.NumberStyles.Float, System.Globalization.CultureInfo.InvariantCulture, out t);
            }
            _newAnnotationTime = t;
            if (t == 0)
                _taniMessage = "Video was not found; try again after playback starts.";
            StateHasChanged();
        }
        catch { }
    }

    private async Task UseCurrentTimeForBookmark()
    {
        _taniMessage = null;
        try
        {
            var s = await JS.InvokeAsync<string>("videoPlayerGetCurrentTime", "vl-watch-video");
            if (!double.TryParse(s, System.Globalization.NumberStyles.Float, System.Globalization.CultureInfo.InvariantCulture, out var t))
                t = 0;
            if (t == 0)
            {
                await Task.Delay(150);
                s = await JS.InvokeAsync<string>("videoPlayerGetCurrentTime", "vl-watch-video");
                double.TryParse(s, System.Globalization.NumberStyles.Float, System.Globalization.CultureInfo.InvariantCulture, out t);
            }
            _newBookmarkTime = t;
            if (t == 0)
                _taniMessage = "Video was not found; try again after playback starts.";
            StateHasChanged();
        }
        catch { }
    }

    private async Task TogglePiPAsync()
    {
        if (_pipSupported != true)
            return;

        try
        {
            if (_isInPiP)
                await JS.InvokeVoidAsync("videoLabExitPiP");
            else
                await JS.InvokeVoidAsync("videoLabEnterPiP", "vl-watch-video");

            _isInPiP = await JS.InvokeAsync<bool>("videoLabIsPiP", "vl-watch-video");
        }
        catch
        {
            _isInPiP = false;
        }
    }

    private async Task ConfirmAndDeleteVideoAsync()
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this video? This action cannot be undone.");
        if (!confirmed) return;

        _deleting = true;
        error = null;
        try
        {
            await Api.DeleteVideoAsync(Id);
            Navigation.NavigateTo("/user/index", forceLoad: false);
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            _deleting = false;
        }
    }

    private async Task AddAnnotation()
    {
        if (string.IsNullOrWhiteSpace(_newAnnotationDesc)) return;
        try
        {
            error = null;
            await Api.CreateAnnotationAsync(new CreateAnnotationRequest
            {
                VideoId = Id,
                TimestampSeconds = Math.Max(0, _newAnnotationTime),
                Description = _newAnnotationDesc.Trim()
            });
            _newAnnotationDesc = "";
            await LoadNotesAsync();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private void StartEditAnnotation(Guid annId, AnnotationItem a)
    {
        _editingAnnotationId = annId;
        _editAnnotationDesc = a.Description ?? "";
        _editAnnotationTime = a.TimestampSeconds;
    }

    private void CancelEditAnnotation()
    {
        _editingAnnotationId = null;
    }

    private async Task SaveAnnotation(Guid annId)
    {
        if (string.IsNullOrWhiteSpace(_editAnnotationDesc)) return;
        try
        {
            error = null;
            await Api.UpdateAnnotationAsync(annId, new UpdateAnnotationRequest
            {
                Description = _editAnnotationDesc.Trim(),
                TimestampSeconds = Math.Max(0, _editAnnotationTime)
            });
            _editingAnnotationId = null;
            await LoadNotesAsync();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task UseCurrentTimeForEditAnnotation()
    {
        try
        {
            var s = await JS.InvokeAsync<string>("videoPlayerGetCurrentTime", "vl-watch-video");
            if (double.TryParse(s, System.Globalization.NumberStyles.Float, System.Globalization.CultureInfo.InvariantCulture, out var t))
                _editAnnotationTime = Math.Max(0, t);
            StateHasChanged();
        }
        catch { }
    }

    private async Task DeleteAnnotation(Guid annotationId)
    {
        try
        {
            error = null;
            await Api.DeleteAnnotationAsync(annotationId);
            await LoadNotesAsync();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task AddBookmark()
    {
        if (string.IsNullOrWhiteSpace(_newBookmarkTitle)) return;
        try
        {
            error = null;
            await Api.CreateBookmarkAsync(new CreateBookmarkRequest
            {
                VideoId = Id,
                TimestampSeconds = Math.Max(0, _newBookmarkTime),
                Title = _newBookmarkTitle.Trim()
            });
            _newBookmarkTitle = "";
            await LoadNotesAsync();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private void StartEditBookmark(Guid bookId, BookmarkItem b)
    {
        _editingBookmarkId = bookId;
        _editBookmarkTitle = b.Title ?? "";
        _editBookmarkTime = b.TimestampSeconds;
    }

    private void CancelEditBookmark()
    {
        _editingBookmarkId = null;
    }

    private async Task SaveBookmark(Guid bookId)
    {
        if (string.IsNullOrWhiteSpace(_editBookmarkTitle)) return;
        try
        {
            error = null;
            await Api.UpdateBookmarkAsync(bookId, new UpdateBookmarkRequest
            {
                Title = _editBookmarkTitle.Trim(),
                TimestampSeconds = Math.Max(0, _editBookmarkTime)
            });
            _editingBookmarkId = null;
            await LoadNotesAsync();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private async Task UseCurrentTimeForEditBookmark()
    {
        try
        {
            var s = await JS.InvokeAsync<string>("videoPlayerGetCurrentTime", "vl-watch-video");
            if (double.TryParse(s, System.Globalization.NumberStyles.Float, System.Globalization.CultureInfo.InvariantCulture, out var t))
                _editBookmarkTime = Math.Max(0, t);
            StateHasChanged();
        }
        catch { }
    }

    private async Task DeleteBookmark(Guid bookmarkId)
    {
        try
        {
            error = null;
            await Api.DeleteBookmarkAsync(bookmarkId);
            await LoadNotesAsync();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private static string FormatTime(double seconds)
    {
        var t = TimeSpan.FromSeconds(seconds);
        return $"{(int)t.TotalMinutes}:{t.Seconds:D2}";
    }
}

<style>
    .vl-watch-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 0 0 0.6rem 0;
        flex-wrap: wrap;
    }

    .vl-watch-back-link {
        color: var(--vl-accent);
        font-size: 0.9rem;
        text-decoration: none;
    }

    .vl-watch-back-link:hover {
        text-decoration: underline;
    }

    .vl-watch-delete-btn {
        margin-left: auto;
    }

    .vl-btn-danger {
        background: var(--vl-danger, #dc2626);
        color: #fff;
        border: none;
        padding: 0.4rem 0.85rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
    }

    .vl-btn-danger:hover:not(:disabled) {
        background: #b91c1c;
    }

    .vl-btn-danger:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .vl-watch-page {
        max-width: none;
        width: 100%;
        margin-top: calc(30px - 1.5rem);
        padding-top: 0;
    }

    .vl-watch-shell {
        margin-top: 0;
        margin-bottom: 0.75rem;
    }

    .vl-video-wrap {
        margin-left: 100px;
        width: 900px;
        height: 500px;
        max-width: calc(100% - 100px);
        background: #000;
        border-radius: var(--vl-radius);
        box-shadow: var(--vl-shadow-lg);
        position: relative;
        overflow: visible;
        z-index: 1;
        isolation: isolate;
    }

    .vl-video-player {
        width: 100%;
        height: 100%;
        display: block;
        object-fit: contain;
        background: #000;
    }

    .vl-video-wrap-plyr .plyr {
        position: relative;
        width: 100%;
        height: 100%;
        min-height: 0;
        border-radius: var(--vl-radius);
        overflow: hidden;
        z-index: 0;
    }

    .vl-video-wrap-plyr .plyr__video-wrapper {
        flex: 1 1 auto;
        min-height: 0;
    }

    .vl-plyr-annotation-overlay {
        position: absolute;
        left: 50%;
        top: 0.75rem;
        transform: translateX(-50%);
        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid rgba(34, 211, 238, 0.7);
        color: #f8fafc;
        border-radius: 12px;
        padding: 0.52rem 0.82rem;
        max-width: calc(100% - 2rem);
        z-index: 2;
        pointer-events: none;
        backdrop-filter: blur(6px);
        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.35);
    }

    .vl-video-wrap-plyr .plyr--fullscreen .vl-plyr-annotation-overlay {
        top: 1rem;
        z-index: 2;
    }

    .vl-plyr-annotation-time {
        background: rgba(6, 182, 212, 0.25);
        color: #a5f3fc;
        border-radius: 999px;
        padding: 0.14rem 0.5rem;
        font-size: 0.78rem;
        font-weight: 800;
        white-space: nowrap;
    }

    .vl-plyr-annotation-text {
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: min(560px, calc(100vw - 4rem));
    }

    .vl-plyr-markers {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 2;
    }

    .vl-plyr-marker {
        pointer-events: auto;
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 10px;
        height: 10px;
        margin-left: 0;
        padding: 0;
        border: none;
        border-radius: 50%;
        background: #06b6d4;
        cursor: pointer;
        z-index: 3;
        box-shadow: 0 0 0 2px rgba(255,255,255,0.8);
    }

    .vl-plyr-marker:hover {
        background: #22d3ee;
        transform: translate(-50%, -50%) scale(1.2);
    }

    .vl-video-wrap-plyr .plyr__progress {
        position: relative;
        overflow: visible;
    }

    .vl-video-wrap-plyr .plyr__controls {
        z-index: 3;
    }

    .vl-watch-fallback {
        margin: 0 0 1rem 0;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.45rem;
    }

    .vl-watch-fallback a { color: var(--vl-accent); }

    .vl-active-annotation-overlay {
        position: absolute;
        left: 50%;
        top: 0.75rem;
        transform: translateX(-50%);
        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid rgba(34, 211, 238, 0.7);
        color: #f8fafc;
        border-radius: 12px;
        padding: 0.52rem 0.82rem;
        max-width: calc(100% - 2rem);
        z-index: 8;
        pointer-events: none;
        backdrop-filter: blur(6px);
        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.35);
    }

    .vl-active-annotation-time {
        background: rgba(6, 182, 212, 0.25);
        color: #a5f3fc;
        border-radius: 999px;
        padding: 0.14rem 0.5rem;
        font-size: 0.78rem;
        font-weight: 800;
        white-space: nowrap;
    }

    .vl-active-annotation-text {
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: min(560px, calc(100vw - 4rem));
    }

    .vl-watch-fallback-sep {
        color: var(--vl-text-muted);
        line-height: 1;
    }

    .vl-pip-btn {
        border: 1px solid var(--vl-border);
        background: #fff;
        color: var(--vl-text);
        border-radius: 999px;
        padding: 0.2rem 0.65rem;
        font-size: 0.75rem;
        font-weight: 700;
        cursor: pointer;
    }

    .vl-pip-btn:hover {
        background: #f8fafc;
    }

    .vl-pip-unsupported {
        color: var(--vl-text-muted);
        font-size: 0.78rem;
    }

    .vl-tani-message {
        margin: 0.5rem 0 0 0;
        font-size: 0.875rem;
        color: var(--vl-danger, #dc2626);
    }

    .vl-notes-layout {
        max-width: 1200px;
        margin-bottom: 50px;
    }

    .vl-watch-notes {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        min-width: 0;
    }

    .vl-watch-notes .vl-notes-section-bookmarks {
        min-width: 0;
    }

    .vl-watch-notes .vl-notes-section-annotations {
        min-width: 0;
    }

    .vl-notes-section {
        background: #fff;
        border-radius: 14px;
        padding: 0.9rem;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
    }

    .vl-section-heading {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.35rem;
    }

    .vl-notes-section-title {
        font-size: 1rem;
        margin: 0;
        color: var(--vl-text);
    }

    .vl-count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 1.6rem;
        height: 1.35rem;
        padding: 0 0.45rem;
        border-radius: 999px;
        background: #eef2ff;
        color: #1e40af;
        font-size: 0.75rem;
        font-weight: 800;
    }

    .vl-notes-section-desc {
        font-size: 0.78rem;
        color: var(--vl-text-muted);
        margin: 0 0 0.7rem 0;
    }

    /* --- Inputs (unified) --- */
    .vl-notes-section .vl-input {
        width: 100%;
        max-width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        font-family: inherit;
        color: var(--vl-text);
        background: #fff;
        border: 1px solid var(--vl-border);
        border-radius: var(--vl-radius-sm);
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .vl-notes-section .vl-input::placeholder {
        color: var(--vl-text-muted);
    }
    .vl-notes-section .vl-input:hover {
        border-color: #cbd5e1;
    }
    .vl-notes-section .vl-input:focus {
        outline: none;
        border-color: var(--vl-accent);
        box-shadow: 0 0 0 3px var(--vl-accent-muted);
    }

    .vl-input-text {
        min-height: 2.25rem;
    }
    .vl-input-search {
        padding-left: 2.25rem;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: 0.65rem center;
        background-size: 1rem;
    }
    .vl-input-num {
        width: 5rem;
        min-width: 4rem;
        text-align: right;
    }

    .vl-filter-wrap {
        margin-bottom: 0.85rem;
    }
    .vl-filter-wrap .vl-input-search {
        max-width: 100%;
    }

    .vl-add-card {
        background: var(--vl-bg);
        border: 1px solid var(--vl-border);
        border-radius: var(--vl-radius);
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .vl-add-card-label {
        display: block;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--vl-text-muted);
        margin-bottom: 0.6rem;
    }
    .vl-add-form-stacked {
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
    }
    .vl-add-form-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .vl-add-form-row-desc .vl-input-text {
        flex: 1;
        min-width: 0;
    }
    .vl-add-form-time-wrap {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.8125rem;
        color: var(--vl-text-muted);
    }
    .vl-add-form-time-wrap .vl-time-label {
        white-space: nowrap;
    }
    .vl-add-form-time-wrap .vl-input-num {
        width: 5rem;
    }
    /* Action row buttons: Now + Add (and Edit form: Now + Save + Cancel) */
    .vl-add-form-row-actions .vl-btn,
    .vl-edit-row .vl-btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 600;
        border-radius: var(--vl-radius-sm);
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.35rem;
        transition: transform 0.18s ease, box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease;
    }
    .vl-add-form-row-actions .vl-btn:focus-visible,
    .vl-edit-row .vl-btn:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px var(--vl-accent-muted);
    }
    .vl-add-form-row-actions .vl-btn:active:not(:disabled),
    .vl-edit-row .vl-btn:active:not(:disabled) {
        transform: scale(0.97);
    }
    .vl-add-form-row-actions .vl-btn-sm.vl-btn-secondary.vl-btn-now,
    .vl-edit-row .vl-btn-sm.vl-btn-secondary.vl-btn-now {
        background: var(--vl-accent-muted);
        color: var(--vl-accent);
        border: 1px solid rgba(6, 182, 212, 0.35);
    }
    .vl-add-form-row-actions .vl-btn-sm.vl-btn-secondary.vl-btn-now:hover:not(:disabled),
    .vl-edit-row .vl-btn-sm.vl-btn-secondary.vl-btn-now:hover:not(:disabled) {
        background: rgba(6, 182, 212, 0.2);
        border-color: var(--vl-accent);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(6, 182, 212, 0.25);
    }
    .vl-add-form-row-actions .vl-btn-sm.vl-btn-secondary:not(.vl-btn-now),
    .vl-edit-row .vl-btn-sm.vl-btn-secondary:not(.vl-btn-now) {
        background: var(--vl-border);
        color: var(--vl-text);
    }
    .vl-add-form-row-actions .vl-btn-sm.vl-btn-secondary:not(.vl-btn-now):hover:not(:disabled),
    .vl-edit-row .vl-btn-sm.vl-btn-secondary:not(.vl-btn-now):hover:not(:disabled) {
        background: #d1d5db;
        transform: translateY(-1px);
    }
    .vl-add-form-row-actions .vl-btn-sm.vl-btn-primary,
    .vl-edit-row .vl-btn-sm.vl-btn-primary {
        background: linear-gradient(180deg, var(--vl-accent) 0%, var(--vl-accent-hover) 100%);
        color: #fff;
        box-shadow: 0 2px 6px rgba(6, 182, 212, 0.35);
    }
    .vl-add-form-row-actions .vl-btn-sm.vl-btn-primary:hover:not(:disabled),
    .vl-edit-row .vl-btn-sm.vl-btn-primary:hover:not(:disabled) {
        background: linear-gradient(180deg, var(--vl-accent-hover) 0%, #0e7490 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
    }
    .vl-add-form-row-actions .vl-btn-sm.vl-btn-primary:disabled,
    .vl-edit-row .vl-btn-sm.vl-btn-primary:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .vl-btn-now {
        flex-shrink: 0;
    }

    .vl-time-label {
        font-size: 0.8125rem;
        color: var(--vl-text-muted);
    }

    .vl-empty-notes {
        font-size: 0.875rem;
        color: var(--vl-text-muted);
        margin: 0;
        padding: 0.5rem 0;
    }
    .vl-empty-filtered {
        padding: 0.75rem;
        background: var(--vl-bg);
        border-radius: var(--vl-radius-sm);
    }

    .vl-notes-section {
        padding: 1.1rem;
        border: 1px solid var(--vl-border);
    }
  

    .vl-notes-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    .vl-note-item {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 0.65rem;
        padding: 0.5rem 0.65rem;
        border: 1px solid var(--vl-border);
        border-radius: var(--vl-radius-sm);
        background: #fff;
        transition: border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
    }
    .vl-note-item-editing {
        grid-template-columns: 1fr;
    }
    .vl-note-actions {
        display: flex;
        gap: 0.25rem;
    }
    .vl-edit-form {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        width: 100%;
    }
    .vl-edit-input {
        width: 100%;
    }
    .vl-edit-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .vl-btn-edit {
        color: var(--vl-text-muted);
        background: transparent;
    }
    .vl-btn-edit:hover {
        color: var(--vl-accent);
        background: #ecfeff;
        border: 1px solid var(--vl-border);
        border-radius: var(--vl-radius-sm);
        background: #fff;
        transition: border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
    }
    .vl-note-item .vl-btn-icon {
        width: 1.5rem;
        height: 1.5rem;
        font-size: 0.95rem;
    }

    .vl-note-item:hover {
        border-color: #cbd5e1;
        background: var(--vl-bg);
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
    }

    .vl-note-item.is-active {
        border-color: var(--vl-accent);
        background: #ecfeff;
        box-shadow: 0 0 0 1px rgba(6, 182, 212, 0.2);
    }

    .vl-note-text {
        min-width: 0;
        font-size: 0.875rem;
        line-height: 1.35;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .vl-note-time {
        flex-shrink: 0;
        background: #e0f2fe;
        color: #0e7490;
        font-size: 0.8rem;
        font-weight: 700;
        padding: 0.28rem 0.6rem;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
    }
    .vl-note-time:hover {
        background: #bae6fd;
        color: #0369a1;
    }

    .vl-btn-icon {
        width: 1.75rem;
        height: 1.75rem;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: var(--vl-radius-sm);
        font-size: 1.15rem;
        line-height: 1;
        cursor: pointer;
        transition: background 0.15s, color 0.15s;
    }
    .vl-btn-remove {
        color: var(--vl-text-muted);
        background: transparent;
    }
    .vl-btn-remove:hover {
        color: var(--vl-danger, #dc2626);
        background: #fef2f2;
    }

    @@media (max-width: 1200px) {
        .vl-video-wrap {
            margin-left: 0;
            width: 700px;
            max-width: 100%;
        }

        .vl-active-annotation-text { max-width: min(420px, calc(100vw - 4rem)); }
    }

    @@media (max-width: 860px) {
        .vl-watch-notes {
            grid-template-columns: 1fr;
        }

        .vl-add-form-row-actions {
            flex-wrap: wrap;
        }
        .vl-add-form-time-wrap .vl-input-num {
            width: 100%;
            min-width: 0;
        }
    }

    @@media (max-width: 760px) {
        .vl-video-wrap {
            width: 100%;
            max-width: 100%;
            margin-left: 0;
            height: 320px;
        }

        .vl-active-annotation-overlay { top: 0.5rem; max-width: calc(100% - 1rem); }

        .vl-active-annotation-text { max-width: 100%; }
    }
</style>
