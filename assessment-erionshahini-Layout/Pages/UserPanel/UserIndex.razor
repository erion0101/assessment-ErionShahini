@page "/user/index"
@attribute [Authorize]
@using assessment_erionshahini_Layout.Data
@using assessment_erionshahini_Layout.Service

<PageTitle>My Videos - Video Lab</PageTitle>

<div class="vl-page">
    <div class="vl-hero">
        <h1>My Videos</h1>
        <p class="vl-text-muted">Your uploaded videos. Click to watch, add annotations, or bookmark.</p>
    </div>

    @if (error != null)
    {
        <div class="vl-alert vl-alert-error">
            @error
            @if (error.Contains("401") || error.Contains("Unauthorized") || error.Contains("Not signed in"))
            {
                <br /><a href="/">Sign in again</a>
            }
        </div>
    }

    @if (loading)
    {
        <p class="vl-text-muted">Loadingâ€¦</p>
    }
    else if (videos.Count == 0)
    {
        <div class="vl-empty">
            <span class="oi oi-video" aria-hidden="true"></span>
            <h3>No videos yet</h3>
            <p>Upload your first video to get started.</p>
            <a href="/user/upload" class="vl-btn vl-btn-primary">Upload Video</a>
        </div>
    }
    else
    {
        <div class="vl-video-grid">
            @foreach (var v in videos)
            {
                <div class="vl-card vl-video-card">
                    <a href="@GetStreamUrl(v)" target="_blank" rel="noopener" class="vl-video-card-link">
                        <span class="oi oi-play-circle" aria-hidden="true"></span>
                        <h3>@v.Title</h3>
                        <p class="vl-video-meta">@v.UploadedAt.ToString("dd MMM yyyy")</p>
                    </a>
                    <a href="/user/watch/@v.Id" class="vl-btn vl-btn-sm vl-btn-secondary">Watch in app</a>
                </div>
            }
        </div>
    }

    <div class="vl-actions vl-actions-bottom">
        <a href="/user/upload" class="vl-card vl-action-card vl-action-primary">
            <span class="oi oi-cloud-upload" aria-hidden="true"></span>
            <h3>Upload Video</h3>
            <p>Add a new video.</p>
        </a>
    </div>
</div>

@code {
    [Inject] private AuthenticatedApiClient Api { get; set; } = null!;
    [Inject] private IConfiguration Config { get; set; } = null!;

    private List<VideoItem> videos = new();
    private bool loading = true;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var list = await Api.GetMyVideosAsync();
            videos = list ?? new List<VideoItem>();
        }
        catch (Exception ex)
        {
            error = ex.Message;
            videos = new List<VideoItem>();
        }
        finally
        {
            loading = false;
        }
    }

    private string GetStreamUrl(VideoItem v)
    {
        var baseUrl = Config["ApiSettings:BaseUrl"]?.TrimEnd('/') ?? "";
        var stream = v.StreamUrl?.TrimStart('/') ?? $"api/Videos/Stream/{v.Id}";
        return $"{baseUrl}/{stream}";
    }
}

<style>
    .vl-page { max-width: 900px; }
    .vl-hero { margin-bottom: 1.5rem; }
    .vl-hero h1 { font-size: 1.75rem; margin-bottom: 0.25rem; }
    .vl-text-muted { color: var(--vl-text-muted); margin: 0; line-height: 1.5; }
    .vl-alert { padding: 0.75rem 1rem; border-radius: var(--vl-radius-sm); margin-bottom: 1rem; }
    .vl-alert-error { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }
    .vl-empty {
        text-align: center;
        padding: 3rem 2rem;
        background: var(--vl-card);
        border-radius: var(--vl-radius);
        box-shadow: var(--vl-shadow);
    }
    .vl-empty .oi { font-size: 3rem; color: var(--vl-accent); opacity: 0.7; margin-bottom: 1rem; }
    .vl-empty h3 { margin: 0 0 0.5rem 0; }
    .vl-empty p { color: var(--vl-text-muted); margin: 0 0 1rem 0; }
    .vl-video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .vl-video-card {
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .vl-video-card-link {
        display: block;
        text-decoration: none;
        color: inherit;
    }
    .vl-video-card-link .oi { font-size: 2rem; color: var(--vl-accent); margin-bottom: 0.5rem; }
    .vl-video-card-link h3 { font-size: 1.125rem; margin: 0 0 0.25rem 0; }
    .vl-video-meta { font-size: 0.875rem; color: var(--vl-text-muted); margin: 0; }
    .vl-btn-sm { padding: 0.375rem 0.75rem; font-size: 0.875rem; }
    .vl-btn-secondary { background: var(--vl-accent-muted); color: var(--vl-accent); }
    .vl-btn-secondary:hover { background: rgba(6, 182, 212, 0.2); }
    .vl-actions-bottom { margin-top: 1rem; }
    .vl-actions { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
    .vl-card {
        background: var(--vl-card);
        border-radius: var(--vl-radius);
        box-shadow: var(--vl-shadow);
        text-decoration: none;
        color: inherit;
        display: block;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .vl-card:hover { transform: translateY(-2px); box-shadow: var(--vl-shadow-lg); }
    .vl-action-card .oi { font-size: 2rem; color: var(--vl-accent); margin-bottom: 0.75rem; }
    .vl-action-card h3 { font-size: 1.125rem; margin: 0 0 0.25rem 0; }
    .vl-action-card p { font-size: 0.875rem; color: var(--vl-text-muted); margin: 0; }
    .vl-action-primary { border: 2px solid var(--vl-accent-muted); padding: 1.5rem; }
</style>
